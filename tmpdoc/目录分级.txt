#!/bin/sh
#先进入WWW目录
cd /opt/zentaopms/
#再进入下一层目录
#cd *
project_path=$(cd `dirname $0`; pwd)
echo $project_path
project_name="${project_path##*/}"
echo $project_name

cd $project_path/www
file_name=$project_path/www/index_old.php
echo $file_name
time=`date	"+%Y-%m-%d-%H-%M"`
covlog=/opt/covlog
mkdir -p /tmp/$project_name && chmod 777 /tmp/$project_name
echo $covlog
new_covlog=/tmp/$project_name/$time
echo $new_covlog
if [ -f $file_name ]
then
echo "文件$file_name存在"
#进入到脚本目录
cd /opt/
php gatherReport.php
cp -r $covlog $new_covlog
rm -rf $covlog/*
scp -r /tmp/$project_name root@10.17.91.33:/usr/local/tomcat8.0.53/webapps/ROOT/report/
rm -rf /tmp/$project_name


curl -H "Content-Type:application/json;charset=utf-8" -X POST -d "{\"msgtype\":\"link\",\"link\": {\"text\":\"PHP代码覆盖率\", \"title\": \"项目名称：$project_name\n日期：$time\", \"picUrl\": \"http://img03.tooopen.com/images/20120807/sy_201208071610186430.jpg\",\"messageUrl\": \"http://10.17.91.33:8080/report/$project_name/$time\"}}" https://oapi.dingtalk.com/robot/send?access_token=ee78ff0f15cfd8c638039c3036aac27c4f6fc9c0837d0cc8bcb0cc3fc92d6c89


else
echo "文件$file_name不存在"
cd $project_path/www
cp index.php index_old.php && rm index.php
mkdir -m 777 -p /opt/covlog
#mkdir -m 777 -p /tmp/git && cd /tmp/git
cd /opt
git clone ssh://git@git.xesv5.com:10088/yanxin3/phpCodeCoverage.git
cp /opt/phpCodeCoverage/src/Woojean/PHPCoverage/index.php $project_path/www/

#sed -i 's/\/opt\/zentaopms\/www\/index_old.php/$project_path/g'  index_old.php
sed -i 's/\/opt\/zentaopms/$project_path/g'  $project_path/www/index.php
fi