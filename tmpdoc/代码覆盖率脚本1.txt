#!/bin/bash
#先进入WWW目录
cd /var/www/html/zentaopms/
#再进入下一层目录
#cd *
project_path=$(cd `dirname $0`; pwd)
echo $project_path
project_name="${project_path##*/}"
echo $project_name

cd $project_path/www
file_name=$project_path/www/index_old.php
echo $file_name
time=`date	"+%Y-%m-%d-%H%M"`
covlog=/opt/covlog
sudo mkdir -p /tmp/$project_name && sudo chmod 777 /tmp/$project_name
echo $covlog
new_covlog=/tmp/$project_name/$time
git=/tmp
echo $git
echo $new_covlog
if [ -d $git/phpCodeCoverage ]
then
echo "存在"
sudo rm -rf $git/phpCodeCoverage
fi
cd $git
git clone ssh://git@git.xesv5.com:10088/yanxin3/phpCodeCoverage.git
sudo mkdir -m 777 -p $covlog
if [ -f $file_name ]
then
echo "文件$file_name存在"
#进入到脚本目录
cd /$git/phpCodeCoverage/src/Woojean/PHPCoverage
sudo php gatherReport.php
sudo cp -r $covlog $new_covlog
sudo rm -rf $covlog/*
sudo scp -r /tmp/$project_name root@10.17.91.33:/usr/local/tomcat8.0.53/webapps/ROOT/report/
sudo rm -rf /tmp/$project_name

sudo curl -H "Content-Type:application/json;charset=utf-8" -X POST -d "{\"msgtype\":\"link\",\"link\": {\"text\":\"PHP代码覆盖率\", \"title\": \"项目名称：$project_name\n日期：$time\", \"picUrl\": \"\",\"messageUrl\": \"http://10.17.91.33:8080/report/$project_name/$time\"}}" https://oapi.dingtalk.com/robot/send?access_token=ee78ff0f15cfd8c638039c3036aac27c4f6fc9c0837d0cc8bcb0cc3fc92d6c89

else
echo "文件$file_name不存在"
cd $project_path/www
sudo cp index.php index_old.php && sudo rm index.php
#mkdir -m 777 -p /tmp/git && cd /tmp/git
sudo cp /tmp/phpCodeCoverage/src/Woojean/PHPCoverage/index.php $project_path/www/
#sed -i 's/\/opt\/zentaopms\/www\/index_old.php/$project_path/g'  index_old.php
sudo sed -i 's#/opt/zentaopms#'$project_path'#g'  $project_path/www/index.php
fi
